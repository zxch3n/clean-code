name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify versions match tag
        shell: bash
        run: |
          set -euo pipefail
          tag_version="${GITHUB_REF_NAME#v}"

          cargo_version="$(python - <<'PY'
          import tomllib
          from pathlib import Path

          data = tomllib.loads(Path("Cargo.toml").read_text("utf-8"))
          print(data["package"]["version"])
          PY
          )"

          npm_version="$(node -p "require('./npm/package.json').version")"

          if [[ "${cargo_version}" != "${tag_version}" ]]; then
            echo "Cargo.toml version (${cargo_version}) does not match tag (${tag_version})" >&2
            exit 1
          fi

          if [[ "${npm_version}" != "${tag_version}" ]]; then
            echo "npm/package.json version (${npm_version}) does not match tag (${tag_version})" >&2
            exit 1
          fi

      - name: Create GitHub Release (if missing)
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"

          if gh release view "${tag}" >/dev/null 2>&1; then
            echo "Release ${tag} already exists"
            exit 0
          fi

          gh release create "${tag}" \
            --title "${tag}" \
            --generate-notes

  build-and-upload:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            use_cross: true
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            use_cross: false
          - os: macos-13
            target: x86_64-apple-darwin
            use_cross: false
          - os: macos-14
            target: aarch64-apple-darwin
            use_cross: false

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust build cache
        uses: Swatinem/rust-cache@v2

      - name: Install cross
        if: matrix.use_cross
        uses: taiki-e/install-action@cross

      - name: Build
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ matrix.use_cross }}" == "true" ]]; then
            cross build --release --locked --target "${{ matrix.target }}"
          else
            cargo build --release --locked --target "${{ matrix.target }}"
          fi

      - name: Prepare asset
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          target="${{ matrix.target }}"

          bin="clean-code"
          ext=""
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            bin="clean-code.exe"
            ext=".exe"
          fi

          asset="clean-code-v${version}-${target}${ext}"
          cp "target/${target}/release/${bin}" "${asset}"
          if [[ "${{ runner.os }}" != "Windows" ]]; then
            chmod +x "${asset}"
          fi

          echo "ASSET=${asset}" >> "${GITHUB_ENV}"

      - name: Upload asset to GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "${GITHUB_REF_NAME}" "${ASSET}" --clobber

